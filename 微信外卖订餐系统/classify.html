<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>店铺</title>
<link rel="stylesheet" type="text/css" href="css/base.css">
<link rel="stylesheet" href="css/classify.css">
</head>
<body>
	<div id="app">
		<div class="header">
		    <div class="content-wrapper">
		        <div class="avatar">
		            <img width="64" height="64" src="images/seller_avatar_256px.jpg">
		        </div>
		        <div class="content">
		            <div class="content_title">
		                <span class="brand"></span>
		                <span class="name" v-text="restaurantName"></span>
		            </div>
		            <div class="description"> 蜂鸟专送/38分钟送达 </div>
		            <div class="support">
		                <span class="icon decrease"></span>
		                <span class="text">在线支付满28减5</span>
		            </div>
		        </div>
		    </div>
		    <div class="bulletin-wrapper">
		        <span class="bulletin-title"></span><span class="bulletin-text">粥品香坊其烹饪粥料的秘方源于中国千年古法，在融和现代制作工艺，由世界烹饪大师屈浩先生领衔研发。坚守纯天然、0添加的良心品质深得消费者青睐，发展至今成为粥类的引领品牌。是2008年奥运会和2013年园博会指定餐饮服务商。</span>
		        <i class="icon-keyboard_arrow_right"></i>
		    </div>
		    <div class="background">
		        <img width="100%" height="100%" src="images/seller_avatar_256px.jpg">
		    </div>
		    <!--loading 提示信息-->
		    <div class="detail fade-transition" style="display: none;">
		        <div class="detail-wrapper clearfix">
		        	<div class="detail-close">
		                <i class="icon-close"></i>
		            </div>
		            <div class="detail-main">
		                <h1 class="name" v-text="restaurantName"></h1>
		                <div class="star-wrapper">
		                    <div class="star star-48">
		                        <span class="star-item on"></span><span class="star-item on"></span><span class="star-item on"></span><span class="star-item on"></span><span class="star-item off"></span>
		                    </div>
		                </div>
		                <div class="title">
		                    <div class="line"></div>
		                    <div class="text">优惠信息</div>
		                    <div class="line"></div>
		                </div>
		                <ul class="supports">
		                    <li class="support-item">
		                        <span class="icon decrease"></span>
		                        <span class="text">在线支付满28减5</span>
		                    </li>
		                    <li class="support-item">
		                        <span class="icon discount"></span>
		                        <span class="text">VC无限橙果汁全场8折</span>
		                    </li>
		                    <li class="support-item">
		                        <span class="icon special"></span>
		                        <span class="text">单人精彩套餐</span>
		                    </li>
		                    <li class="support-item">
		                        <span class="icon invoice"></span>
		                        <span class="text">该商家支持发票,请下单写好发票抬头</span>
		                    </li>
		                    <li class="support-item">
		                        <span class="icon guarantee"></span>
		                        <span class="text">已加入“外卖保”计划,食品安全保障</span>
		                    </li>
		                </ul>
		                <div class="title">
		                    <div class="line"></div>
		                    <div class="text">商家公告</div>
		                    <div class="line"></div>
		                </div>
		                <div class="bulletin">
		                    <p class="content">
		                    	粥品香坊其烹饪粥料的秘方源于中国千年古法，在融和现代制作工艺，由世界烹饪大师屈浩先生领衔研发。坚守纯天然、0添加的良心品质深得消费者青睐，发展至今成为粥类的引领品牌。是2008年奥运会和2013年园博会指定餐饮服务商。
		                    </p>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
		<div class="main">
		    <div class="left-menu" id="left">
		        <ul>
		            <li><span>苹果手机</span></li>
		            <li><span>华为手机</span></li>
		            <li><span>小米手机</span></li>
		            <li><span>OPPO手机</span></li>
		            <li><span>魅族手机</span></li>
		            <li><span>三星手机</span></li>
		            <li><span>谷歌手机</span></li>
		        </ul>
		    </div>
		    <div class="con">
		        <div class="right-con con-active" style="display: none;">
		            <ul>
		            	<li v-for="product in products1">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		               </li>
		                <li class="sell_out">
		                    <div class="menu-img"><img src="images/demo.jpg"></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="01">红烧范炜昕</h4>
		                        <p class="list1">家常菜</p>
		                        <p class="list2">
		                            <b>￥</b><b>0.1</b>
		                        </p>
		                        <div class="btn" style="display:none">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">0.1</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products2">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products3">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products4">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products5">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products6">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		        <div class="right-con" style="display: none;">
		            <ul>
		                <li v-for="product in products7">
		                    <div class="menu-img"><img v-bind:src="product.goodsImg" /></div>
		                    <div class="menu-txt">
		                        <h4 data-icon="00">{{product.goodsName}}</h4>
		                        <p class="list1">{{product.goodsDesc}}</p>
		                        <p class="list2">
		                            <b>￥</b><b>{{product.goodsPrice}}</b>
		                        </p>
		                        <div class="btn">
		                            <button class="minus"></button>
		                            <i>0</i>
		                            <button class="add" @click="addProduct(product)"></button>
		                            <i class="price">{{product.goodsPrice}}</i>
		                        </div>
		                    </div>
		                </li>
		            </ul>
		        </div>
		    </div>
		    <div class="up1"></div>
		    <div class="shopcart-list fold-transition">
		        <div class="list-header">
		            <h1 class="title">购物车</h1>
		            <span class="empty">清空所有</span>
		        </div>
		        <div class="list-content">
		            <ul></ul>
		        </div>
		    </div>
		    <div class="footer">
		        <div class="left">
		        	<div class="count_num"><span id="totalcountshow">0</span></div>
		            <span id="cartN" class="nowrap">总计：<span id="totalpriceshow">0</span>元</span> 
		        </div>
		        <div class="right">
		            <a id="btnselect" class="xhlbtn" onclick="check()" href="order_notes.html">去结算</a>
		        </div>
		    </div>
		</div>
		<!--商品信息 - 弹出框-->
		<div class="subFly">
		    <div class="up"></div>
		    <div class="down">
		        <a class="close" href="javascript:">
		            <img src="images/close.png" alt="">
		        </a>
		        <dl class="subName">
		            <dt><img class="imgPhoto" src=""></dt>
		            <dd>
		                <p data-icon=""></p>
		                <p><span>¥ </span><span class="pce"></span></p>
		                <p>
		                    <span>已选：“</span>
		                    <span class="choseValue"></span>
		                    <span>”</span>
		                </p>
		            </dd>
		        </dl>
		        <dl class="subChose">
		            <dt>规格</dt>
		            <dd class="m-active">特大份</dd>
		            <dd>大份</dd>
		            <dd>中份</dd>
		            <dd>小份</dd>
		        </dl>
		        <dl class="subCount">
		            <dt>购买数量</dt>
		            <dd class="mydd">
		                <div class="btn" style="padding-top:5px;">
		                    <button class="ms" style="display: inline-block;">
		                    	<strong></strong>
		                    </button>
		                    <i class="mask_number">1</i>
		                    <button class="ad">
		                    	<strong></strong>
		                    </button>
		                    <i class="price">0</i>
		                </div>
		            </dd>
		        </dl>
		        <div class="foot" @click="addCart">
		            <span>加入购物车</span>
		        </div>
		    </div>
		</div>
	</div>
</body>
<script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="js/add.js"></script>
<script src="js/vuejs-2.5.16.js"></script>
<script src="js/axios-0.18.0.js"></script>
<script src="js/api.js"></script>
<script src="js/mock-min.js"></script>
<script src="js/mock.js"></script>
<script>
	//减少购物车商品数量
	function sub(id){
		var a = parseFloat($("#ms2"+id).siblings(".price").text());  //当前商品单价
		var n = parseInt($("#ms2"+id).next().text())-1;  //当前商品数量
		var s = parseFloat($("#totalpriceshow").text());  //总金额
		if(n == 0){
			$("#ms2"+id).parent().parent().remove();
			$(".up1").hide();
		}
		$("#ms2"+id).next().text(n);
		$("#ms2"+id).parent().prev().children("span:nth-child(2)").text(a*n);
		$("#totalcountshow").text(parseInt($("#totalcountshow").text())-1);
		$("#totalpriceshow").text(s-a);
		if(parseFloat($("#totalcountshow").text())==0){
			$(".shopcart-list").hide();
			$(".right").find("a").addClass("disable");
		}
		if(sessionStorage.getItem("isLogin") == 0){
			var carts = sessionStorage.getItem("userCarts");
			carts = JSON.parse(carts);
			for(let i = 0; i < carts.length; i++) {
				if(carts[i].proId == id) {
					if(n == 0){
						carts.splice(i,1);
					}else{
						carts[i].proNumber = n;
						carts[i].proTotalPrice = s-a;
					}
					break
				}
			}
			sessionStorage.setItem("userCarts", JSON.stringify(carts))
			if(carts.length == 0){
				sessionStorage.removeItem("userCarts");
			}
			$.ajax({
				type:"get",
				url:"http://localhost:9527/joy-cart/cart/subCount",
				data:"cartId="+id+"&userId="+sessionStorage.getItem("userId"),
				dataType:"json",
				success:function(data){
					sessionStorage.setItem("userCarts", data.data.result)
					window.location.reload();
				}
			});
		}else{
			var carts = localStorage.getItem("carts");
			carts = JSON.parse(carts);
			for(let i = 0; i < carts.length; i++) {
				if(carts[i].proId == id) {
					if(n == 0){
						carts.splice(i,1);
					}else{
						carts[i].proNumber = n;
						carts[i].proTotalPrice = s-a;
					}
					break
				}
			}
			localStorage.setItem("carts", JSON.stringify(carts))
			if(carts.length == 0){
				localStorage.removeItem("carts");
			}
		}
	};
	//增加购物车商品数量
	function add(id){
		var n = parseInt($("#ad2"+id).prev().text())+1;
		$("#ad2"+id).prev().text(n);    //当前商品数量+1
		var p = parseFloat($("#ad2"+id).next().text());    //隐藏的价格
		$("#ad2"+id).parent().prev().children("span.accountPrice").text((p*n).toFixed(2));  //计算该商品规格的总价值
		$("#totalcountshow").text(parseFloat($("#totalcountshow").text())+1);//总数量＋1
		$("#totalpriceshow").text(parseFloat($("#totalpriceshow").text())+p);
		if(sessionStorage.getItem("isLogin") == 0){
			var carts = sessionStorage.getItem("userCarts");
			carts = JSON.parse(carts);
			for(let i = 0; i < carts.length; i++) {
				if(carts[i].proId == id) {
					carts[i].proNumber = n;
					carts[i].proTotalPrice = p*n;
					break
				}
			}
			sessionStorage.setItem("userCarts", JSON.stringify(carts))
			$.ajax({
				type:"get",
				url:"http://localhost:9527/joy-cart/cart/addCount",
				data:"cartId="+id+"&userId="+sessionStorage.getItem("userId"),
				dataType:"json",
				success:function(data){
					sessionStorage.setItem("userCarts", data.data.result)
					window.location.reload();
				}
			});
		}else{
			var carts = localStorage.getItem("carts");
			carts = JSON.parse(carts);
			for(let i = 0; i < carts.length; i++) {
				if(carts[i].proId == id) {
					carts[i].proNumber = n;
					carts[i].proTotalPrice = p*n;
					break
				}
			}
			localStorage.setItem("carts", JSON.stringify(carts))
		}
	};
	function check(){
		if(sessionStorage.getItem("isLogin") == 0){
			if(sessionStorage.getItem("userCarts") == null){
				$("#btnselect").removeAttr("href")
			}else{
				$("#btnselect").attr("href", "order_notes.html");
			}
		}else{
			if(localStorage.getItem("carts") == null){
				$("#btnselect").removeAttr("href")
			}else{
				$("#btnselect").attr("href", "order_notes.html");
			}
		}
	};
</script>
<script>
	new Vue({
		el: '#app',
		data: {
			restaurantName: '小煜外卖',
			products1:[{}],
			products2:[{}],
			products3:[{}],
			products4:[{}],
			products5:[{}],
			products6:[{}],
			products7:[{}],
			goodsTypes:[{}],
			currentChoose:{},
			carts:{},
			cart:{
				proId:'',
				proName:'',
				proNumber:'',
				proTotalPrice:'',
				proPrice:'',
				currentUserId:''
			},
			loginParams:{
				code:"",
			},
			cartsParams:{
				token:'',
				carts:{}
			}
		},
		methods: {
			addProduct:function(product){
				this.currentChoose = product;
			},
			addCart:function(){
				//将新添加到购物车的商品作为购物车中的对象赋值
				this.cart.proId = this.currentChoose.goodsId;
				this.cart.proName = this.currentChoose.goodsName;
				this.cart.proNumber = $(".mask_number").text();
				this.cart.proTotalPrice = this.currentChoose.goodsPrice * parseInt($(".mask_number").text());
				this.cart.proPrice = this.currentChoose.goodsPrice
				let carts;
				if(sessionStorage.getItem("isLogin") == 0){
		    		//获取用户保存的购物车
					carts = sessionStorage.getItem("userCarts");
		    	}else{
		    		//获取本地保存的购物车
					carts = localStorage.getItem("carts");
		    	}
				//判断本地保存的商品不为空
				if(carts != null) {
					//定义变量记录是否为新物品
					let isnew = true
					//将字符串转为JSON
					carts = JSON.parse(carts)
					//遍历长度
					for(let i = 0; i < carts.length; i++) {
						//判断每一个proid是否等于商品proid
						if(carts[i].proId == this.cart.proId) {
							//相等,将当前数量与本地保存的数量相加
							carts[i].proNumber = parseInt(carts[i].proNumber) + parseInt(this.cart.proNumber)
							carts[i].proTotalPrice = parseInt(carts[i].proTotalPrice) + parseInt(this.cart.proTotalPrice)
							//本地与当前相同,改为false
							isnew = false
							break
						}
					}
					//判断是否为新物品
					if(isnew) {
						//新物品放到集合
						carts.push(this.cart)
					}
				} else {
					//本地保存的商品为空,
					carts = [this.cart]
				}
				if(sessionStorage.getItem("isLogin") == 0){
		    		//将新添加入购物车的商品id保存下来
					sessionStorage.setItem("newCartId", this.cart.proId)
					//保存到本地,将字符串转为JSON格式
					sessionStorage.setItem("userCarts", JSON.stringify(carts))
					//请求后台
					this.cart.currentUserId = sessionStorage.getItem("userId");
					addCart(this.cart).then(res=>{
						sessionStorage.setItem("userCarts", res.data.result)
					});
		    	}else{
		    		//将新添加入购物车的商品id保存下来
					localStorage.setItem("newCartId", this.cart.proId)
					//保存到本地,将字符串转为JSON格式
					localStorage.setItem("carts", JSON.stringify(carts))
		    	}
			},
		},
		created:function() {
			//加载商品类别
			getGoodsTypeList().then(res=>{
        		this.goodsTypes = res.data.result;
			});
			//加载商品
        	getProductList().then(res=>{
        		this.products1 = res.data.result[0];
        		this.products2 = res.data.result[1];
        		this.products3 = res.data.result[2];
        		this.products4 = res.data.result[3];
        		this.products5 = res.data.result[4];
        		this.products6 = res.data.result[5];
        		this.products7 = res.data.result[6];
			});
			//获取code
			var getUrlObject = function(){
			    function parseQueryString(url){
			        var str = url.split("?")[1];   //通过?得到一个数组,取?后面的参数
			        var items = str.split("&");    //分割成数组
			        var arr,name,value;
			
			        for(var i=0; i<items.length; i++){
			            arr = items[i].split("=");    //["key0", "0"]
			            name = arr[0];
			            value = arr[1];
			            this[name] = value;
			        }
			    }
			    var url = window.location.href;//获取本页面的URL，包括问号后面拼接的部分
			    var data = new parseQueryString(url);
			    return data;
			}
			//向后台传递code来完成登录后的数据同步
			var params = getUrlObject();
			if(params.code == null){
				this.carts = localStorage.getItem("carts");
			}
			this.loginParams.code = params.code;
			login(this.loginParams).then(res=>{
				sessionStorage.setItem("isLogin", res.data.code);
				sessionStorage.setItem("userId", res.data.currentUserId);
				localStorage.setItem("token", res.data.result);
				if(localStorage.getItem("carts") != null){
					this.cartsParams.carts = JSON.parse(localStorage.getItem("carts"));
				}else{
					this.cart.proId = null;
					this.cart.proName = null;
					this.cart.proNumber = null;
					this.cart.proTotalPrice = null;
					this.cart.proPrice = null;
					this.cartsParams.carts = [this.cart];
				}
				this.cartsParams.token = localStorage.getItem("token");
				mergerOfCarts(this.cartsParams).then(res=>{
					sessionStorage.setItem("userCarts", JSON.stringify(res.data.result));
					if(sessionStorage.getItem("isLogin") == 0){
						if(sessionStorage.getItem("userCarts") != null){
							var carts = sessionStorage.getItem("userCarts");
							carts = JSON.parse(carts);
							var taste = $(".subChose .m-active").text();
							var cartsTotalPrice = 0;
							var cartsTotalCount = 0;
							for(let i = 0; i < carts.length; i++) {
								var addtr = '<li class="food">';
								addtr += '<div><span class="accountName">'+carts[i].proName+'</span><span class="taste">'+taste+'</span></div>';
								addtr += '<div><span>￥</span><span class="accountPrice">'+carts[i].proTotalPrice+'</span></div>';
								addtr += '<div class="btn">';
								addtr += '<button class="ms2" id="ms2'+carts[i].proId+'" onclick="sub('+carts[i].proId+')" style="display: inline-block;"></button>';
								addtr += '<i class="li_acount">'+carts[i].proNumber+'</i>';
								addtr += '<button class="ad2" id="ad2'+carts[i].proId+'" onclick="add('+carts[i].proId+')"></button>';
								addtr += '<i class="price" style="display: none;">'+carts[i].proPrice+'</i>';
								addtr += '</div>';
								addtr += '</li>';
								$(".list-content ul").append(addtr);
								cartsTotalCount = cartsTotalCount + parseInt(carts[i].proNumber);
								cartsTotalPrice = cartsTotalPrice + carts[i].proTotalPrice;
							}
							$("#totalcountshow").html(cartsTotalCount);
							$("#totalpriceshow").html(cartsTotalPrice);
						};
						if(sessionStorage.getItem("userCarts") == null){
							$(".right").find("a").addClass("disable");
						}
						localStorage.removeItem("carts");
					}else{
						if(localStorage.getItem("carts") != null){
							var carts = localStorage.getItem("carts");
							carts = JSON.parse(carts);
							var taste = $(".subChose .m-active").text();
							var cartsTotalPrice = 0;
							var cartsTotalCount = 0;
							for(let i = 0; i < carts.length; i++) {
								var addtr = '<li class="food">';
								addtr += '<div><span class="accountName">'+carts[i].proName+'</span><span class="taste">'+taste+'</span></div>';
								addtr += '<div><span>￥</span><span class="accountPrice">'+carts[i].proTotalPrice+'</span></div>';
								addtr += '<div class="btn">';
								addtr += '<button class="ms2" id="ms2'+carts[i].proId+'" onclick="sub('+carts[i].proId+')" style="display: inline-block;"></button>';
								addtr += '<i class="li_acount">'+carts[i].proNumber+'</i>';
								addtr += '<button class="ad2" id="ad2'+carts[i].proId+'" onclick="add('+carts[i].proId+')"></button>';
								addtr += '<i class="price" style="display: none;">'+carts[i].proPrice+'</i>';
								addtr += '</div>';
								addtr += '</li>';
								$(".list-content ul").append(addtr);
								cartsTotalCount = cartsTotalCount + parseInt(carts[i].proNumber);
								cartsTotalPrice = cartsTotalPrice + carts[i].proTotalPrice;
							}
							$("#totalcountshow").html(cartsTotalCount);
							$("#totalpriceshow").html(cartsTotalPrice);
						};
						if(localStorage.getItem("carts") == null){
							$(".right").find("a").addClass("disable");
						}
					}
				})
			});
		},
	})
</script>
</html>
